name: Deploy Agent to LiveKit Cloud

on:
  push:
    paths:
      - 'agent/**'
      - '.github/workflows/deploy-agent.yml'
  workflow_dispatch:

env:
  AGENT_DIR: agent

jobs:
  deploy:
    name: Deploy to LiveKit Cloud
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install LiveKit CLI
        run: |
          curl -sSL https://get.livekit.io/cli | bash
          lk --version

      - name: Add LiveKit project
        env:
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
        run: |
          lk project add ${{ secrets.LIVEKIT_PROJECT_NAME }} \
            --url ${{ secrets.LIVEKIT_URL }} \
            --api-key ${{ secrets.LIVEKIT_API_KEY }} \
            --api-secret ${{ secrets.LIVEKIT_API_SECRET }} \
            --default

      - name: Create livekit.toml
        working-directory: ${{ env.AGENT_DIR }}
        run: |
          cat > livekit.toml <<EOF
          [project]
            subdomain = "${{ secrets.LIVEKIT_PROJECT_NAME }}"
          
          [agent]
            id = "${{ env.LIVEKIT_AGENT_ID }}"
          EOF

      - name: Deploy agent
        working-directory: ${{ env.AGENT_DIR }}
        env:
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
        run: |
          echo "Deploying agent: ${{ env.LIVEKIT_AGENT_ID }}"
          lk agent deploy --project ${{ secrets.LIVEKIT_PROJECT_NAME }} .
          

      - name: Check agent status
        working-directory: ${{ env.AGENT_DIR }}
        env:
          LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
        run: |
          lk agent status --project ${{ secrets.LIVEKIT_PROJECT_NAME }}

      - name: Deployment summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Agent ID:** ${{ env.LIVEKIT_AGENT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

